{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block content %}
<div class="module small">
  <img width="100" height="100" src="https://img.icons8.com/external-flat-design-circle/64/external-Cache-Memory-cloud-computing-flat-design-circle.png" alt="external-Cache-Memory-cloud-computing-flat-design-circle"/>
  <h1 class="title">{% trans "Cache Control" %}</h1>

  {# Container for success/error/info messages #}
  <div id="message-container"></div>

  <form id="cache-form" class="inline-form compact">
    {% csrf_token %}
    <fieldset class="module aligned compact">
      <legend>{% trans "Select tags to invalidate" %}</legend>

      <div class="form-row">
        <label class="form-checkbox">
          <input type="checkbox" id="select-all" />
          {% trans "Select All" %}
        </label>
      </div>

      {# Loop through MODEL_TAGS dict: model name and its tags #}
      {% for model, tags in MODEL_TAGS.items %}
        <div class="form-row model-group">
          <strong>{{ model }}</strong>
          <div class="tag-checkboxes">
            {% for tag in tags %}
              <label class="form-checkbox cell">
                <input type="checkbox" name="tags" value="{{ tag }}" />
                {{ tag }}
              </label>
            {% endfor %}
          </div>
        </div>
      {% empty %}
        <p>{% trans "No cache tags configured." %}</p>
      {% endfor %}
    </fieldset>

    <div class="submit-row">
      <button type="submit" class="default">{% trans "Invalidate Selected" %}</button>
    </div>
  </form>
</div>

<style>
  .module.small { max-width: 720px; margin: 1em auto; }
  .module.small .title { margin-bottom: 0.75em; font-size: 1.5em; }
  .inline-form.compact .form-row { margin-bottom: 0.5em; }
  .model-group { border-bottom: 1px solid #ddd; padding-bottom: 0.5em; margin-bottom: 0.5em; }
  .tag-checkboxes { display: flex; flex-wrap: wrap; gap: 0.5em; margin-top: 0.25em; }
  .tag-checkboxes .cell { white-space: nowrap; }

  /* Message styles */
  #message-container .success {
    color: #004d40;
    background-color: rgba(0, 255, 255, 0.2);
    padding: 0.5em;
    margin-bottom: 1em;
    border-radius: 0.25em;
  }
  #message-container .error {
    color: #b71c1c;
    background-color: rgba(255, 0, 0, 0.2);
    padding: 0.5em;
    margin-bottom: 1em;
    border-radius: 0.25em;
  }
</style>

<script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function(){
    const form = document.getElementById("cache-form");
    const selectAll = document.getElementById("select-all");
    const messages = document.getElementById("message-container");

    // Toggle all checkboxes
    selectAll.addEventListener("change", function(){
      document.querySelectorAll('input[name="tags"]').forEach(cb => cb.checked = this.checked);
    });

    // Handle form submission via AJAX
    form.addEventListener("submit", function(e){
      e.preventDefault();
      messages.innerHTML = "";

      const formData = new FormData(form);
      const csrfToken = formData.get('csrfmiddlewaretoken');
      const tags = formData.getAll('tags');
      const params = new URLSearchParams();
      tags.forEach(t => params.append('tags', t));
      params.append('csrfmiddlewaretoken', csrfToken);

      fetch(window.location.href, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: params.toString()
      })
      .then(resp => {
        return resp.json().then(data => ({status: resp.status, ok: resp.ok, data}));
      })
      .then(({status, ok, data}) => {
        const div = document.createElement('div');
        const result = data.detail?.tags_received || data.detail || data.result || '';

        if (ok) {
          div.className = 'success';
        } else {
          div.className = 'error';
        }

        // Display array or string
        if (Array.isArray(result)) {
          div.textContent = result.join(', ');
        } else {
          div.textContent = result;
        }

        messages.appendChild(div);
      })
      .catch(err => {
        const div = document.createElement('div');
        div.className = 'error';
        div.textContent = err;
        messages.appendChild(div);
      });
    });
  });
</script>

{% endblock %}
